
CREATE TABLE `task` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `task_name` VARCHAR(64) DEFAULT NULL COMMENT '任务名称',
  `task_status` TINYINT NOT NULL DEFAULT '0' COMMENT '任务状态：1-初始化，2-执行成功，3 执行失败 4.正在执行中',
  `fail_count` INT NOT NULL DEFAULT '0' COMMENT '失败次数 最多执行三次',
  `error_msg` VARCHAR(128) DEFAULT NULL COMMENT '失败原因',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`)
) ENGINE=INNODB AUTO_INCREMENT=9 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;


CREATE TABLE `task_history` (
  `id` INT NOT NULL,
  `task_name` VARCHAR(64) DEFAULT NULL COMMENT '任务名称',
  `task_status` TINYINT NOT NULL DEFAULT '0' COMMENT '任务状态：1-初始化，2-执行成功，3 执行失败 4.正在执行中',
  `fail_count` INT NOT NULL DEFAULT '0' COMMENT '失败次数 最多执行三次',
  `error_msg` VARCHAR(128) DEFAULT NULL COMMENT '失败原因',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`)
) ENGINE=INNODB AUTO_INCREMENT=9 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;


DELIMITER //
CREATE FUNCTION rand_string(n INT)
RETURNS VARCHAR(255) #该函数会返回一个字符串
BEGIN
DECLARE chars_str VARCHAR(100) DEFAULT
'abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ';
DECLARE return_str VARCHAR(255) DEFAULT '';
DECLARE i INT DEFAULT 0;
WHILE i < n DO
SET return_str =CONCAT(return_str,SUBSTRING(chars_str,FLOOR(1+RAND()*52),1));
SET i = i + 1;
END WHILE;
RETURN return_str;
END //
DELIMITER ;


SET GLOBAL log_bin_trust_function_creators=1;


DELIMITER //
CREATE PROCEDURE insert_task( max_num INT )
BEGIN
DECLARE i INT DEFAULT 0;
SET autocommit = 0; #设置手动提交事务
REPEAT #循环
SET i = i + 1; #赋值
INSERT INTO task (task_name, task_status ) VALUES
(rand_string(6),1);
UNTIL i = max_num
END REPEAT;
COMMIT; #提交事务
END //
DELIMITER ;


-- 插入10个任务
CALL insert_task(10);




